{% extends 'health/base_health.html' %}
{% load i18n %}

{% block extra_css %}
<style>
/* Star Rating Component - Mobile First */
.rating-field {
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--gray-100);
}

.rating-field:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.rating-label {
    display: block;
    font-weight: 500;
    font-size: 0.9375rem;
    margin-bottom: 4px;
}

.rating-hint {
    display: block;
    font-size: 0.8125rem;
    color: var(--gray-500);
    margin-bottom: 10px;
}

.star-container {
    display: flex;
    gap: 4px;
}

.star {
    width: 44px;
    height: 44px;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
}

.star svg {
    width: 36px;
    height: 36px;
    transition: transform 0.1s ease;
}

.star:active svg {
    transform: scale(0.9);
}

.star.empty svg {
    fill: var(--gray-300);
}

.star.filled svg {
    fill: #facc15;
}

/* Touch feedback */
@media (hover: hover) {
    .star:hover svg {
        transform: scale(1.1);
    }
}

/* Smaller stars on very small screens */
@media (max-width: 360px) {
    .star {
        width: 38px;
        height: 38px;
    }
    .star svg {
        width: 30px;
        height: 30px;
    }
}
</style>
{% endblock %}

{% block main_content %}
<form id="dailyForm">
    {% csrf_token %}

    <div class="card summary-card">
        <h2>{% trans "Was today a good day?" %}</h2>
        <div class="day-rating">
            <label class="rating-option">
                <input type="radio" name="good_day" value="yes" {% if entry.good_day == 'yes' %}checked{% endif %}>
                <span class="rating-btn good">{% trans "Yes" %}</span>
            </label>
            <label class="rating-option">
                <input type="radio" name="good_day" value="mixed" {% if entry.good_day == 'mixed' %}checked{% endif %}>
                <span class="rating-btn mixed">{% trans "Mixed" %}</span>
            </label>
            <label class="rating-option">
                <input type="radio" name="good_day" value="no" {% if entry.good_day == 'no' %}checked{% endif %}>
                <span class="rating-btn bad">{% trans "No" %}</span>
            </label>
        </div>
    </div>

    <div class="card">
        <h2>{% trans "Mood & Engagement" %}</h2>
        <p class="card-subtitle">{% trans "Happiness indicators" %}</p>

        <div class="rating-field">
            <span class="rating-label">{% trans "Tail / Body Language" %}</span>
            <span class="rating-hint">{% trans "Relaxed, wagging vs stiff" %}</span>
            <div class="star-container" data-field="tail_body_language" data-value="{{ default_values.tail_body_language|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Interest in People" %}</span>
            <span class="rating-hint">{% trans "Seeks affection vs disengaged" %}</span>
            <div class="star-container" data-field="interest_people" data-value="{{ default_values.interest_people|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Interest in Environment" %}</span>
            <span class="rating-hint">{% trans "Sniffing, alert vs dull" %}</span>
            <div class="star-container" data-field="interest_environment" data-value="{{ default_values.interest_environment|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Enjoyment of Favorites" %}</span>
            <span class="rating-hint">{% trans "Toys, walks, treats" %}</span>
            <div class="star-container" data-field="enjoyment_favorites" data-value="{{ default_values.enjoyment_favorites|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Overall Spark" %}</span>
            <span class="rating-hint">{% trans "Joy vs flatness" %}</span>
            <div class="star-container" data-field="overall_spark" data-value="{{ default_values.overall_spark|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="card">
        <h2>{% trans "Appetite & Eating" %}</h2>

        <div class="rating-field">
            <span class="rating-label">{% trans "Appetite" %}</span>
            <span class="rating-hint">{% trans "Eats willingly vs refusal" %}</span>
            <div class="star-container" data-field="appetite" data-value="{{ default_values.appetite|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Food Enjoyment" %}</span>
            <span class="rating-hint">{% trans "Excited vs reluctant" %}</span>
            <div class="star-container" data-field="food_enjoyment" data-value="{{ default_values.food_enjoyment|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Nausea Signs" %}</span>
            <span class="rating-hint">{% trans "5 = none, 1 = vomiting" %}</span>
            <div class="star-container" data-field="nausea_signs" data-value="{{ default_values.nausea_signs|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Weight / Body Condition" %}</span>
            <span class="rating-hint">{% trans "Stable vs noticeable loss" %}</span>
            <div class="star-container" data-field="weight_condition" data-value="{{ default_values.weight_condition|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="metric" style="margin-top: 20px;">
            <label>{% trans "Meals Eaten Today" %}</label>
            <div class="meal-checkboxes">
                <label class="checkbox-option">
                    <input type="checkbox" name="breakfast" {% if entry.breakfast %}checked{% endif %}>
                    <span>{% trans "Breakfast" %}</span>
                </label>
                <label class="checkbox-option">
                    <input type="checkbox" name="lunch" {% if entry.lunch %}checked{% endif %}>
                    <span>{% trans "Lunch" %}</span>
                </label>
                <label class="checkbox-option">
                    <input type="checkbox" name="dinner" {% if entry.dinner %}checked{% endif %}>
                    <span>{% trans "Dinner" %}</span>
                </label>
                <label class="checkbox-option">
                    <input type="checkbox" name="treats" {% if entry.treats %}checked{% endif %}>
                    <span>{% trans "Treats" %}</span>
                </label>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>{% trans "Energy & Mobility" %}</h2>

        <div class="rating-field">
            <span class="rating-label">{% trans "Energy Level" %}</span>
            <span class="rating-hint">{% trans "Normal vs lethargic" %}</span>
            <div class="star-container" data-field="energy_level" data-value="{{ default_values.energy_level|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Willingness to Move" %}</span>
            <span class="rating-hint">{% trans "Gets up easily vs hesitation" %}</span>
            <div class="star-container" data-field="willingness_move" data-value="{{ default_values.willingness_move|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Walking Comfort" %}</span>
            <span class="rating-hint">{% trans "Smooth gait vs limping" %}</span>
            <div class="star-container" data-field="walking_comfort" data-value="{{ default_values.walking_comfort|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Resting Comfort" %}</span>
            <span class="rating-hint">{% trans "Settles easily vs restless" %}</span>
            <div class="star-container" data-field="resting_comfort" data-value="{{ default_values.resting_comfort|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="card">
        <h2>{% trans "Pain & Physical Comfort" %}</h2>

        <div class="rating-field">
            <span class="rating-label">{% trans "Breathing Comfort" %}</span>
            <span class="rating-hint">{% trans "Normal vs labored" %}</span>
            <div class="star-container" data-field="breathing_comfort" data-value="{{ default_values.breathing_comfort|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Pain Signs" %}</span>
            <span class="rating-hint">{% trans "5 = none, 1 = panting, whining" %}</span>
            <div class="star-container" data-field="pain_signs" data-value="{{ default_values.pain_signs|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Sleep Quality" %}</span>
            <span class="rating-hint">{% trans "Restful vs disrupted" %}</span>
            <div class="star-container" data-field="sleep_quality" data-value="{{ default_values.sleep_quality|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rating-field">
            <span class="rating-label">{% trans "Response to Touch" %}</span>
            <span class="rating-hint">{% trans "Enjoys vs flinches" %}</span>
            <div class="star-container" data-field="response_touch" data-value="{{ default_values.response_touch|default:'' }}">
                {% for i in "12345" %}
                <button type="button" class="star empty" data-value="{{ forloop.counter }}">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="card">
        <h2>{% trans "Notes" %}</h2>

        <div class="metric">
            <label>{% trans "What made today good?" %}</label>
            <textarea name="good_notes" rows="2" placeholder="{% trans 'Optional...' %}">{{ entry.good_notes }}</textarea>
        </div>

        <div class="metric">
            <label>{% trans "What seemed hardest?" %}</label>
            <textarea name="hard_notes" rows="2" placeholder="{% trans 'Optional...' %}">{{ entry.hard_notes }}</textarea>
        </div>

        <div class="metric">
            <label>{% trans "Other observations" %}</label>
            <textarea name="other_notes" rows="2" placeholder="{% trans 'Fever, coughing, diarrhea, bad breath changes...' %}">{{ entry.other_notes }}</textarea>
        </div>
    </div>

    <button type="submit" class="save-btn">{% trans "Save Today's Entry" %}</button>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize star ratings with pre-filled values
    document.querySelectorAll('.star-container').forEach(container => {
        const currentValue = container.dataset.value;
        if (currentValue && currentValue !== '' && currentValue !== 'None') {
            updateStars(container, parseInt(currentValue));
        }
    });

    // Star click handler
    document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', function() {
            const container = this.closest('.star-container');
            const value = parseInt(this.dataset.value);
            updateStars(container, value);
        });
    });

    function updateStars(container, value) {
        container.dataset.value = value;
        container.querySelectorAll('.star').forEach(star => {
            const starValue = parseInt(star.dataset.value);
            if (starValue <= value) {
                star.classList.remove('empty');
                star.classList.add('filled');
            } else {
                star.classList.remove('filled');
                star.classList.add('empty');
            }
        });
    }

    // Form submission
    document.getElementById('dailyForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // Collect star rating values
        const data = {
            good_day: document.querySelector('input[name="good_day"]:checked')?.value || '',
            breakfast: document.querySelector('input[name="breakfast"]').checked,
            lunch: document.querySelector('input[name="lunch"]').checked,
            dinner: document.querySelector('input[name="dinner"]').checked,
            treats: document.querySelector('input[name="treats"]').checked,
            good_notes: document.querySelector('textarea[name="good_notes"]').value,
            hard_notes: document.querySelector('textarea[name="hard_notes"]').value,
            other_notes: document.querySelector('textarea[name="other_notes"]').value,
        };

        // Collect all star ratings
        document.querySelectorAll('.star-container').forEach(container => {
            const field = container.dataset.field;
            const value = container.dataset.value;
            data[field] = (value && value !== '' && value !== 'None') ? parseInt(value) : null;
        });

        try {
            const response = await fetch('{% url "health:save_entry" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                showToast('{% trans "Entry saved!" %}');
            } else {
                showToast('{% trans "Error saving entry" %}');
            }
        } catch (err) {
            showToast('{% trans "Error saving entry" %}');
        }
    });
});
</script>
{% endblock %}
